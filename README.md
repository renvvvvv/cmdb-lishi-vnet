# 飞书多维表格历史数据查询插件

一个用于从 API 拉取历史数据并写入飞书多维表格的插件，支持跨表格操作、暂停与继续、智能回退等功能。

## � 版本信息

- **当前版本**：v2.1.2
- **更新日期**：2025-01-20

## 🎯 核心功能

### 1. 历史数据查询
- 从 API 拉取测点历史数据
- 支持自定义时间范围
- 支持时间间隔配置（秒）
- 支持聚合函数（avg, sum, max, min, count）
- 每个数据点创建一条独立记录

### 2. 跨表格操作
- **数据源表格**：读取测点ID（默认当前表格）
- **目标表格**：写入查询结果（支持配置URL）
- 支持 Base 和 Wiki 多维表格
- 自动解析表格 URL

### 3. 暂停与继续
- 随时暂停数据拉取
- 自动保存进度（每10条记录）
- 支持更换目标表格
- 从上次进度继续
- 刷新页面后自动恢复
- 进度保存24小时

### 4. 智能回退机制
- 追踪当前写入状态
- 暂停时如果正在写入，自动回退索引
- 继续时重新请求该测点的完整数据
- 确保数据完整性

### 5. 智能处理
- 自动识别飞书超链接格式的测点ID
- 自动拼接被分割的测点ID
- 自动去重（测点+时间戳）
- 自动创建目标表格字段
- 请求延时保护（查询500ms，写入200ms）

### 6. 代理服务器
- 解决 CORS 跨域问题
- 转发 API 请求
- 支持 Basic 认证
- 默认端口：3001

## 🚀 快速开始

### 1. 安装依赖

```bash
npm install
```

### 2. 启动服务

```bash
# 启动代理服务器（必须）
npm run proxy

# 启动开发服务器（必须）
npm run dev
```

### 3. 配置插件

1. 在飞书多维表格中添加插件：http://localhost:3000
2. 粘贴目标表格 URL
3. 设置时间范围
4. 点击"开始历史数据查询"

## ⚙️ 默认配置

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| 数据源表格 | 当前表格 | 读取测点ID的表格 |
| App ID | cli_a8495c3aba10d00b | 飞书机器人ID |
| App Secret | 2jyb2v28yXHPeKW2IuIqPlwyigTP66uq | 飞书机器人密钥 |
| 测点列名 | 测点 | 包含测点ID的列名 |
| 时间间隔 | 3600秒 | 1小时 |
| API地址 | http://localhost:3001 | 代理服务器 |
| 聚合函数 | 无 | 可选：avg, sum, max, min, count |
| 数据格式 | 仅最新值 | 可选：仅数值、所有数据点、数据点数量 |

## 📊 输出格式

### 目标表格字段

插件会自动在目标表格中创建以下字段：

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| 测点 | 文本 | 测点ID | 29.125073.1.1.8.1.1.1.2.1 |
| 时间戳 | 文本 | 毫秒时间戳 | 1768836060000 |
| 时间 | 文本 | 格式化时间 | 2025-01-19 14:01:00 |
| 值 | 文本 | 测点值 | 22.5 |

### 数据量计算

```
总记录数 = 测点数量 × 数据点数量
数据点数量 = (结束时间 - 开始时间) / 时间间隔
```

**示例**：
- 10个测点
- 24小时时间范围
- 3600秒（1小时）间隔
- 数据点数量 = 24个
- 总记录数 = 10 × 24 = 240条

## 🎮 操作按钮

| 按钮 | 功能 | 使用场景 |
|------|------|----------|
| 开始 | 开始新的数据查询 | 首次查询 |
| 暂停 | 暂停当前查询，保存进度 | 需要更换表格、网络不稳定 |
| 继续 | 从上次进度继续查询 | 暂停后恢复、更换表格后继续 |
| 停止 | 完全停止并清除进度 | 取消查询 |

## 📖 使用场景

### 场景1：常规数据查询

```
1. 配置目标表格 URL
2. 设置时间范围
3. 点击"开始"
4. 等待完成
```

### 场景2：大量数据分批处理

```
1. 开始查询
2. 处理到一定数量后点击"暂停"
3. 更换目标表格 URL
4. 点击"继续"
5. 重复步骤2-4直到完成
```

**适用情况**：
- 表格行数接近上限（40万+）
- 需要分批管理数据
- 数据量超过单个表格容量

### 场景3：网络中断恢复

```
1. 查询过程中网络中断
2. 点击"暂停"保存进度
3. 等待网络恢复
4. 点击"继续"恢复查询
```

### 场景4：意外中断恢复

```
1. 浏览器意外关闭或刷新
2. 重新打开插件
3. 自动检测未完成任务
4. 点击"继续"恢复同步
```

## 🔧 技术实现

### 项目结构

```
├── index.html          # 插件界面
├── main.js            # 主逻辑
├── api.js             # API 封装
├── style.css          # 样式
├── proxy-server.js    # 代理服务器
├── vite.config.js     # Vite 配置
├── package.json       # 依赖配置
└── README.md          # 本文档
```

### 核心技术

- **前端**：Vite + @lark-base-open/js-sdk + 原生 JavaScript
- **后端**：Node.js + Express + node-fetch
- **存储**：localStorage（进度保存）+ 飞书多维表格（数据存储）

### 状态管理

```javascript
state = {
  sourceTable: null,      // 数据源表格
  targetTable: null,      // 目标表格
  isSyncing: false,       // 是否正在同步
  isPaused: false,        // 是否暂停
  syncProgress: {
    currentIndex: 0,      // 当前处理索引
    recordIdList: [],     // 记录ID列表
    total: 0,             // 总记录数
    successCount: 0,      // 成功数量
    failCount: 0,         // 失败数量
    isWriting: false,     // 是否正在写入
    currentPointId: null  // 当前测点ID
  }
}
```

### 智能回退机制

**问题**：暂停时如果测点数据正在写入，可能导致数据不完整。

**解决**：
1. 追踪当前是否正在写入数据（`isWriting`）
2. 记录当前正在处理的测点ID（`currentPointId`）
3. 暂停时如果正在写入，自动回退索引
4. 继续时重新请求该测点的完整数据

```javascript
// 暂停时
if (state.syncProgress.isWriting && state.syncProgress.currentIndex > 0) {
  state.syncProgress.currentIndex--;
  log(`测点 ${state.syncProgress.currentPointId} 未完全写入，继续时将重新处理`);
}
```

### 字段创建优化

**问题**：创建字段后使用手动构造的字段对象，导致写入失败。

**解决**：创建字段后重新获取字段列表，使用完整的字段对象。

```javascript
if (fieldsCreated) {
  log('重新获取字段列表以确保字段ID正确...', 'info');
  fieldList = await state.targetTable.getFieldMetaList();
  
  pointField = fieldList.find(f => f.name === '测点');
  timestampField = fieldList.find(f => f.name === '时间戳');
  timeField = fieldList.find(f => f.name === '时间');
  valueField = fieldList.find(f => f.name === '值');
  
  log('✓ 所有字段已就绪', 'success');
}
```

## ⚠️ 注意事项

### 必须条件
- ✅ 代理服务器必须运行（npm run proxy）
- ✅ 开发服务器必须运行（npm run dev）
- ✅ 目标表格 URL 必须配置
- ✅ 测点列名必须正确

### 限制条件
- ⚠️ 暂停后不能更换数据源表格
- ⚠️ 暂停后不能修改时间范围
- ⚠️ 进度保存24小时后过期
- ⚠️ 清除浏览器缓存会丢失进度

### 性能建议
- 💡 单次查询建议 < 10000条记录
- 💡 测点数量建议 < 100个
- 💡 时间范围建议 < 30天
- 💡 大量数据建议分批处理

### 飞书超链接问题

**问题**：飞书多维表格会自动将类似 IP 的测点ID识别为超链接（显示为蓝色）。

**示例**：测点ID `29.125073.1.1.8.1.1.1.2.1` 中的 `1.1.8.1` 会被识别为超链接。

**影响**：单元格值变成富文本格式（数组包含多个片段）。

**解决**：插件已自动处理，会拼接所有文本片段，不影响查询。

## 🔍 故障排查

### 问题1：查不到数据

**检查项**：
- [ ] 测点ID格式是否正确
- [ ] 时间范围内是否有数据
- [ ] API地址是否正确（应该是 http://localhost:3001）
- [ ] 代理服务器是否运行

**解决**：
```bash
# 检查代理服务器
npm run proxy

# 查看日志
# 在插件界面查看详细日志
```

### 问题2：写入失败

**检查项**：
- [ ] 目标表格 URL 是否正确
- [ ] 是否有表格编辑权限
- [ ] 字段类型是否兼容

**解决**：
1. 点击"测试连接目标表格"验证
2. 查看日志中的"目标表格"名称
3. 确认有编辑权限

### 问题3：进度丢失

**检查项**：
- [ ] 是否超过24小时
- [ ] 浏览器缓存是否被清除
- [ ] 是否使用同一个浏览器

**解决**：
- 使用同一个浏览器和设备
- 不要清除浏览器缓存
- 24小时内完成任务

### 问题4：部分数据点写入失败

**错误信息**：`field not found error`

**原因**：字段对象不完整

**解决**：已在 v2.1.2 版本修复，确保使用最新版本。

### 问题5：速度太慢

**优化方法**：
- 减少测点数量
- 缩短时间范围
- 增大时间间隔
- 使用聚合函数

## 📈 性能指标

### 处理速度
- 单个测点：约1秒（含延时）
- 100个测点：约100秒
- 1000个测点：约1000秒（约17分钟）

### 数据量建议
- 单个表格：< 30万条记录
- 单次查询：< 10000条记录
- 单个测点：< 1000个数据点

### 延时设置
- 查询延时：500ms（避免API限流）
- 写入延时：200ms（避免表格限流）
- 进度保存：每10条记录

## 🔐 API 配置

### 请求格式

```bash
POST http://localhost:3001/tsdb/point_data/v2/search
Authorization: Basic dGVjaG5pcXVlX2NlbnRlcjoyMVZpYW5ldEBWbmV0LmNvbQ==
Content-Type: application/json

{
  "startTime": 1765239798223,
  "endTime": 1765243398223,
  "interval": "3600",
  "function": "avg",
  "pointList": ["29.125073.1.1.8.1.1.1.2.1"]
}
```

### 响应格式

```json
{
  "code": 200,
  "msg": "查询成功",
  "success": true,
  "data": {
    "29.125073.1.1.8.1.1.1.2.1": [
      {"timestamp": 1765239798223, "value": 22.5},
      {"timestamp": 1765240398223, "value": 23.1},
      {"timestamp": 1765240998223, "value": 22.8}
    ]
  }
}
```

### 认证信息

```
用户名: technique_center
密码: 21Vianet@Vnet.com
Base64: dGVjaG5pcXVlX2NlbnRlcjoyMVZpYW5ldEBWbmV0LmNvbQ==
```

## 🎯 最佳实践

### 1. 首次使用
- 用 1-2 个测点测试
- 确认配置正确
- 再批量处理

### 2. 时间范围
- 短期：最近 1-24 小时
- 中期：最近 1-7 天
- 长期：最近 1-3 个月

### 3. 数据量控制
- 时间范围 × 测点数量 = 总数据量
- 建议单次查询 < 10000 个数据点
- 使用聚合函数减少数据量

### 4. 错误处理
- 查看日志定位问题
- 使用测试工具验证
- 分批处理降低风险

### 5. 暂停与继续
- 可以在任何时候暂停
- 系统会自动处理数据完整性
- 无需担心数据丢失

## 🛠️ 开发

### 本地开发

```bash
# 安装依赖
npm install

# 启动代理服务器
npm run proxy

# 启动开发服务器
npm run dev
```

### 构建

```bash
npm run build
```

### 测试工具

打开 `test-history-api.html` 可以独立测试 API 请求，无需启动插件。

## 📝 更新日志

### v2.1.2 (2025-01-20)
- 🐛 修复：字段创建后写入失败的问题
- ✨ 优化：创建字段后重新获取字段列表
- ✨ 增强：错误处理和失败统计

### v2.1.1 (2025-01-20)
- ✨ 新增：智能回退机制
- ✨ 优化：暂停时自动回退未完成的测点
- ✨ 增强：继续时重新处理被打断的测点

### v2.1.0 (2025-01-20)
- ✨ 新增：暂停与继续功能
- ✨ 新增：进度自动保存和恢复
- ✨ 新增：支持更换目标表格
- ✨ 新增：自动创建目标表格字段

### v2.0.0 (2025-01-19)
- ✨ 新增：历史数据查询功能
- ✨ 新增：跨表格操作
- ✨ 新增：每个数据点一条记录
- ✨ 新增：自动识别飞书超链接格式
- ✨ 新增：代理服务器解决 CORS 问题

## 📄 许可证

MIT License

## 🆘 技术支持

如有问题，请：
1. 查看本文档
2. 检查日志输出
3. 使用测试工具（test-history-api.html）
4. 联系技术支持

---

**版本**：v2.1.2  
**更新**：2025-01-20  
**状态**：生产就绪 ✅
